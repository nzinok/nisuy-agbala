<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>砖  转注住拽转</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/nzinok/questionnaire-site/fe58ebe6cc328ce515da4bdece58cb1886d3c9bd/%D7%A0%D7%A7%D7%95%D7%93%D7%AA%20%D7%96%D7%99%D7%A0%D7%95%D7%A7%20%D7%A2%D7%9C%20%D7%A8%D7%A7%D7%A2%20%D7%98%D7%A8%D7%99%D7%A7%D7%95%D7%9C%D7%95%D7%A8%20(1).png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary-blue:#4facfe;--primary-purple:#667eea;--submit-purple-start:#8854d0;--submit-purple-end:#a55eea;--light-gray:#f0f4f8;--dark-text:#334155;--border-color:#ddd;--error-red:#e53935;--success-green:#27ae60}
        *{margin:0;padding:0;box-sizing:border-box}
        html{scroll-behavior:smooth}
        body{font-family:'Rubik',sans-serif;background:linear-gradient(135deg, var(--primary-purple) 0%, #764ba2 100%);min-height:100vh;padding:20px;color:var(--dark-text)}
        .container{max-width:800px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.1);overflow:hidden}
        #debug-box { background: #1a1a1a; color: #00ff00; padding: 15px; margin: 20px; border-radius: 8px; text-align: left; direction: ltr; white-space: pre-wrap; word-break: break-all; font-family: monospace; border: 2px solid #555; }
        .question,.file-upload-block,.confirmation-block{margin-bottom:25px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05);border:1px solid transparent}
        .prefilled-field { background-color: #f0f4f8; color: #555; cursor: not-allowed; }
        .instruction-text{padding:15px 20px;background-color:var(--light-gray);border-right:5px solid var(--primary-purple);margin-bottom:20px;border-radius:8px;font-size:1rem;line-height:1.6}
        .confirmation-details { text-align: right; margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; background-color: #fafafa; white-space: pre-wrap; }
        .confirmation-label { display: flex; align-items: center; justify-content: flex-start; cursor: pointer; font-size: 1.1rem; }
        .confirmation-label input[type=checkbox] { width: 1.3em; height: 1.3em; margin-left: 10px; }
        .required-mark{color:var(--error-red);font-weight:bold;margin-left:4px}
        .question.invalid,.file-upload-block.invalid,.confirmation-block.invalid{border-color:var(--error-red);box-shadow:0 0 0 3px rgba(229,57,53,.2)}
        .error-message-inline{color:var(--error-red);margin-top:8px;font-size:.9rem;min-height:1.2em;text-align:center}
    </style>
</head>
<body>
    <div id="container" class="container">
        <div class="header">
            <h1 id="headerTitle">砖  转注住拽转</h1>
            <div id="progress-header" style="display:none;">
                <div id="sectionInfo" style="margin-top:10px; font-size:0.9rem;"></div>
                <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
                <div id="section-progress-container-wrapper"></div>
            </div>
        </div>
        <div id="mainArea" class="content-area">
            <div id="loading" style="display:none;"><div class="spinner"></div><p id="loadingText">转 砖 专 砖...</p></div>
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" style="display:none;"><h2>转!</h2><p>转砖转 砖专 爪.</p></div>
            <div id="introScreen" style="display:none;"><h2 id="introTitle"></h2><div id="introBody" class="instruction-text"></div><button id="startBtn" class="btn">转 转 砖</button></div>
            <div id="questionnaireContent" class="question-area">
                <div id="questionsContainer"></div>
                <div class="button-group">
                    <button id="prevBtn" class="btn">拽</button>
                    <button id="nextBtn" class="btn"></button>
                    <button id="submitBtn" class="btn submit-btn" style="display:none;">砖转 砖</button>
                </div>
            </div>
        </div>
    </div>
    <div id="save-indicator"></div>

    <script>
        // --- THIS SCRIPT IS THE DEBUG VERSION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzL1_urvLIQijNhICI5SV1YKwCx6HVOXNjD93SscpsQULUXzDwu9jtxjBbJoRNI6vXU/exec";
        
        let questionnaireData = {}, currentSection = 0, sections = [], answers = {};
        let nextSectionJump = null, sectionHistory = [], autosaveInterval = null, stickyHeaderPoint = 0;
        let sessionToken = null;
        let prefilledEmail = null; 

        const ui = { container: document.getElementById('container'), mainArea: document.getElementById('mainArea'), intro: document.getElementById('introScreen'), introTitle: document.getElementById('introTitle'), introBody: document.getElementById('introBody'), headerTitle: document.getElementById('headerTitle'), loading: document.getElementById('loading'), loadingText: document.getElementById('loadingText'), error: document.getElementById('errorMessage'), success: document.getElementById('successMessage'), questionnaire: document.getElementById('questionnaireContent'), questionsContainer: document.getElementById('questionsContainer'), startBtn: document.getElementById('startBtn'), prevBtn: document.getElementById('prevBtn'), nextBtn: document.getElementById('nextBtn'), submitBtn: document.getElementById('submitBtn'), sectionInfo: document.getElementById('sectionInfo'), progressBar: document.getElementById('progressBar'), saveIndicator: document.getElementById('save-indicator'), sectionProgressWrapper: document.getElementById('section-progress-container-wrapper'), progressHeader: document.getElementById('progress-header') };
        
        async function init() {
            showView(ui.loading);
            const urlParams = new URLSearchParams(window.location.search);
            sessionToken = urlParams.get('token');
            if (!sessionToken) return onLoadError(new Error("拽砖专  转拽.   拽 砖 (拽)."));
            
            try {
                const requestBody = { action: 'getQuestionnaireWithToken', payload: { token: sessionToken } };
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(requestBody), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                if (!response.ok) throw new Error(`砖转 砖专转: ${response.status}`);
                const data = await response.json();
                
                // --- DEBUG: Display the raw data received from the server ---
                const debugBox = document.createElement('pre');
                debugBox.id = 'debug-box';
                debugBox.textContent = "--- DATA RECEIVED FROM SERVER ---\n" + JSON.stringify(data, null, 2);
                ui.mainArea.insertBefore(debugBox, ui.loading);
                // --- END DEBUG ---

                onDataReceived(data);
            } catch (error) {
                onLoadError(error);
            }
        }
        
        // The rest of the script is the same as the final version you had.
        function onDataReceived(response){if(!response.success){return onLoadError(new Error(response.message))}
        if(response.prefillData&&response.prefillData.email){prefilledEmail=response.prefillData.email}
        ui.progressHeader.style.display='block';if(response.introduction){ui.introTitle.textContent=response.introduction.title;ui.headerTitle.textContent=response.introduction.title;ui.introBody.textContent=response.introduction.body}
        questionnaireData=response.data;sections=response.sectionsOrder;sectionHistory=[];if(sections.length===0){return onLoadError(new Error(' 爪 拽注 砖.'))}
        showView(ui.intro);setTimeout(()=>{const mainHeader=document.querySelector('.header');if(mainHeader){stickyHeaderPoint=mainHeader.offsetTop+mainHeader.offsetHeight}},100)}
        function displayCurrentSection(){showView(ui.questionnaire);const sectionName=sections[currentSection];const originalItems=questionnaireData[sectionName].items||[];let items;if(questionnaireData[sectionName].randomize){const pinnedItems=originalItems.filter(item=>item.type.toLowerCase()==='专转');const shuffleableItems=originalItems.filter(item=>item.type.toLowerCase()!=='专转');const shuffledItems=shuffleArray(shuffleableItems);items=[...pinnedItems,...shuffledItems]}else{items=originalItems}
        let html=`<div class="category-section"><h3 class="category-title">${sectionName}</h3>`;for(let i=0;i<items.length;i++){const item=items[i];const nextItem=(i+1<items.length)?items[i+1]:null;if(item.type.toLowerCase()==='专转'&&nextItem&&nextItem.type.toLowerCase()==='拽抓'){html+=buildCombinedFileUploadHtml(item,nextItem,sectionName,i);i++}else{html+=buildItemHtml(item,sectionName,i)}}
        ui.questionsContainer.innerHTML=html;initCustomControls();updateProgressBars();updateNavigation()}
        function buildItemHtml(item,sectionName,index){const sanitizedQuestionText=sanitizeTextForKey(item.question);const answerKey=`${sectionName}: ${sanitizedQuestionText}`;const safeId=`q-${currentSection}-${index}`;const requiredMark=item.required?`<span class="required-mark">*</span>`:'';const itemType=item.type.toLowerCase();const currentValue=answers[answerKey];if(itemType==='专转')return`<div class="instruction-text">${item.text}</div>`;if(itemType==='砖专'){return buildConfirmationHtml(item,currentValue,answerKey,safeId)}
        if(itemType==='_'){return buildPrefilledEmailHtml(item,answerKey)}
        let html=`<div class="question" data-required="${item.required||false}" data-key="${answerKey}"><div class="question-text">${item.question}${requiredMark}</div><div class="question-input">`;if(itemType.startsWith('拽住')||itemType.startsWith('住驻专')||itemType.startsWith('砖')){const inputType=itemType.startsWith('住驻专')?'number':'text';const tag=itemType.startsWith('拽住')?`<textarea oninput="handleTyping(this)" onblur="handleTextBlur(this)" rows="4">${currentValue||''}</textarea>`:`<input type="${inputType}" value="${currentValue||''}" oninput="handleTyping(this)" onblur="handleTextBlur(this)">`;html+=tag}else if(itemType.startsWith('专')){html+=buildRatingHtml(item,currentValue,answerKey)}else if(itemType.startsWith('专 专')){html+=buildCheckboxHtml(item,currentValue,answerKey,safeId)}else if(itemType.startsWith('专 转 专砖')){html+=buildSelectHtml(item,currentValue,answerKey,safeId)}else if(itemType.startsWith('拽抓')){html+=buildFileUploadHtml({question:item.question,required:item.required},answerKey,safeId)}else{html+=`<input type="text" value="${currentValue||''}" oninput="handleTyping(this)" onblur="handleTextBlur(this)">`}
        return html+`</div><div class="error-message-inline"></div></div>`}
        function buildConfirmationHtml(item,currentValue,answerKey,safeId){let html=`<div class="confirmation-block" data-required="${item.required||false}" data-key="${answerKey}">`;if(item.details){html+=`<div class="confirmation-details">${item.details}</div>`}
        const isChecked=currentValue==='砖专';const requiredMark=item.required?`<span class="required-mark">*</span>`:'';html+=`<label class="confirmation-label" for="${safeId}"><input type="checkbox" id="${safeId}" onchange="handleConfirmationClick(this)" ${isChecked?'checked':''}><span>${item.question}${requiredMark}</span></label><div class="error-message-inline"></div></div>`;return html}
        function buildPrefilledEmailHtml(item,answerKey){if(prefilledEmail&&!answers[answerKey]){setTimeout(()=>saveAnswer(answerKey,prefilledEmail),0)}
        const value=prefilledEmail||answers[answerKey]||'';const requiredMark=item.required?`<span class="required-mark">*</span>`:'';let html=`<div class="question" data-required="${item.required||false}" data-key="${answerKey}"><div class="question-text">${item.question}${requiredMark}</div><div class="question-input"><input type="email" value="${value}" class="prefilled-field" readonly></div><div class="error-message-inline"></div></div>`;return html}
        function handleConfirmationClick(checkbox){const answerKey=checkbox.closest('.confirmation-block').dataset.key;const value=checkbox.checked?'砖专':'';saveAnswer(answerKey,value)}
        async function submitQuestionnaire(){if(!validateRequiredQuestions())return;showView(ui.loading);ui.loadingText.textContent='砖 转砖转...';ui.submitBtn.disabled=true;if(autosaveInterval)clearInterval(autosaveInterval);const submissionData={action:'saveAnswers',payload:{answers:answers,timestamp:new Date().toISOString(),token:sessionToken}};try{const response=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify(submissionData),headers:{'Content-Type':'text/plain;charset=utf-8'}});const result=await response.json();if(result.success){localStorage.removeItem('questionnaireAutoSave_'+sessionToken);showView(ui.success)}else{throw new Error(result.message)}}catch(error){onSubmitError(error)}}
        function saveLocalDraft(){if(!sessionToken)return;try{const draftData={answers:answers,currentSection:currentSection,sectionHistory:sectionHistory,timestamp:new Date().toISOString()};localStorage.setItem('questionnaireAutoSave_'+sessionToken,JSON.stringify(draftData));ui.saveIndicator.textContent=`砖专: ${new Date().toLocaleTimeString()}`;ui.saveIndicator.style.opacity='1';setTimeout(()=>{ui.saveIndicator.style.opacity='0.5'},3000)}catch(e){console.error('Error saving draft:',e)}}
        function loadLocalDraft(){if(!sessionToken)return null;try{const savedData=localStorage.getItem('questionnaireAutoSave_'+sessionToken);if(!savedData)return null;const draftData=JSON.parse(savedData);if((new Date-new Date(draftData.timestamp))/(1000*3600*24)>7){localStorage.removeItem('questionnaireAutoSave_'+sessionToken);return null}
        return draftData}catch(e){console.error('Error loading draft:',e);return null}}
        function sanitizeTextForKey(text){if(typeof text!=='string')return'';return text.replace(/[\r\n\t]/g,' ').replace(/[\u200B-\u200D\uFEFF]/g,'').trim()}
        function scrollToNext(currentElement){const sectionName=sections[currentSection];const shouldScroll=questionnaireData[sectionName]?.autoScroll;if(shouldScroll===false||!currentElement)return;const allQuestions=Array.from(ui.questionsContainer.querySelectorAll('.question, .file-upload-block, .confirmation-block'));const currentIndex=allQuestions.findIndex(el=>el===currentElement);if(currentIndex>-1&&currentIndex<allQuestions.length-1){const nextQuestionEl=allQuestions[currentIndex+1];setTimeout(()=>{nextQuestionEl.scrollIntoView({behavior:'smooth',block:'center'})},200)}}
        function startQuestionnaire(){if(!checkForDraft()){currentSection=0;displayCurrentSection();startAutosave()}}
        function buildRatingHtml(item,currentValue,answerKey){const min=item.ratingConfig?.min||1;const max=item.ratingConfig?.max||5;let html=`<div class="rating-group"><span class="rating-label-text"> </span><div class="rating-boxes" data-key="${answerKey}">`;for(let j=min;j<=max;j++){html+=`<div class="rating-box ${currentValue==j?'selected':''}" onclick="handleRatingClick(this)" data-value="${j}">${j}</div>`}
        return html+`</div><span class="rating-label-text"></span></div>`}
        function buildCheckboxHtml(item,currentValue,answerKey,safeId){const limitMatch=item.type.match(/:\s*(\d+)/);const limit=limitMatch?parseInt(limitMatch[1],10):0;const currentValues=Array.isArray(currentValue)?currentValue:(currentValue?String(currentValue).split(', '):[]);let html=`<div class="checkbox-group" id="${safeId}" data-limit="${limit}" data-key="${answerKey}">`;(item.options||[]).forEach(opt=>{html+=`<label><input type="checkbox" name="${safeId}_option" value="${opt}" ${currentValues.includes(opt)?'checked':''} onclick="handleCheckboxClick(this)"><span class="tag-label">${opt}</span></label>`});html+=`</div>`;return html}
        function buildSelectHtml(item,currentValue,answerKey,safeId){let currentText='专...';if(currentValue)currentText=currentValue.startsWith('专: ')?'专':currentValue;let html=`<div class="custom-select" data-answer-key="${answerKey}" data-safe-id="${safeId}" id="select_${safeId}"><div class="custom-select-trigger" tabindex="0">${currentText}</div><div class="custom-options">`;(item.options||[]).forEach(opt=>{html+=`<div class="custom-option" data-value="${opt}">${opt}</div>`});html+=`   </div></div>`;if((item.options||[]).includes('专')){const otherText=(currentValue&&currentValue.startsWith('专: '))?currentValue.replace('专: ',''):'';const displayStyle=(currentText==='专')?'display:block;':'';html+=`<input type="text" id="other_${safeId}" class="hidden-other-input" style="${displayStyle}" placeholder=" 驻专..." value="${otherText}" oninput="handleTyping(this)" onblur="handleTextBlur(this)">`}
        return html}
        function buildFileUploadHtml(item,answerKey,safeId){const currentValue=answers[answerKey];const fileName=(currentValue&&currentValue.filename)?currentValue.filename:'';const requiredMark=item.required?`<span class="required-mark">*</span>`:'';const safeAnswerKeyForAttr=JSON.stringify(answerKey);return`<div class="file-upload-block" data-required="${item.required||false}" data-key="${answerKey}"><div class="file-upload-title">${item.question}${requiredMark}</div><label class="file-drop-area" id="drop-area-${safeId}"><input type="file" onchange='handleFileSelect(this, ${safeAnswerKeyForAttr}, "${safeId}")'><div class="file-drop-icon"></div><div class="file-drop-message">专专 拽抓   抓 专</div><div class="file-name-display ${fileName?'success':''}" id="file-name-${safeId}">${fileName}</div></label><div class="error-message-inline"></div></div>`}
        function buildCombinedFileUploadHtml(instructionItem,fileItem,sectionName,index){const sanitizedQuestionText=sanitizeTextForKey(fileItem.question);const answerKey=`${sectionName}: ${sanitizedQuestionText}`;const safeId=`q-${currentSection}-${index}`;const currentValue=answers[answerKey];const fileName=currentValue?currentValue.filename:'';const requiredMark=fileItem.required?`<span class="required-mark">*</span>`:'';const safeAnswerKeyForAttr=JSON.stringify(answerKey);return`<div class="question" data-required="${fileItem.required||false}" data-key="${answerKey}"><div class="file-upload-block"><div class="file-upload-title">${instructionItem.text}</div><label class="file-drop-area" id="drop-area-${safeId}"><input type="file" onchange='handleFileSelect(this, ${safeAnswerKeyForAttr}, "${safeId}")'><div class="file-drop-icon"></div><div class="file-drop-message">${fileItem.question}${requiredMark}</div><div class="file-name-display" id="file-name-${safeId}">${fileName}</div></label></div><div class="error-message-inline"></div></div>`}
        function initCustomControls(){document.querySelectorAll('.custom-select').forEach(wrapper=>{const trigger=wrapper.querySelector('.custom-select-trigger');const options=wrapper.querySelectorAll('.custom-option');const safeId=wrapper.dataset.safeId;trigger.addEventListener('click',()=>wrapper.classList.toggle('open'));options.forEach(option=>{option.addEventListener('click',e=>{e.stopPropagation();trigger.textContent=option.textContent;wrapper.classList.remove('open');handleSelectChange(option,wrapper,safeId)})})});window.addEventListener('click',e=>{if(!e.target.closest('.custom-select')){document.querySelectorAll('.custom-select.open').forEach(w=>w.classList.remove('open'))}});document.querySelectorAll('.file-drop-area').forEach(area=>{['dragenter','dragover','dragleave','drop'].forEach(eventName=>area.addEventListener(eventName,e=>{e.preventDefault();e.stopPropagation()}));['dragenter','dragover'].forEach(eventName=>area.addEventListener(eventName,()=>area.classList.add('dragover')));['dragleave','drop'].forEach(eventName=>area.addEventListener(eventName,()=>area.classList.remove('dragover')));area.addEventListener('drop',e=>{const fileInput=area.querySelector('input[type="file"]');fileInput.files=e.dataTransfer.files;fileInput.dispatchEvent(new Event('change',{bubbles:true}))})});document.querySelectorAll('.checkbox-group').forEach(group=>{let maxWidth=0;const labels=group.querySelectorAll('.tag-label');if(labels.length===0)return;labels.forEach(label=>{if(label.offsetWidth>maxWidth)maxWidth=label.offsetWidth});labels.forEach(label=>{label.style.width=`${maxWidth}px`})})}
        function handleRatingClick(element){const answerKey=element.closest('.rating-boxes').dataset.key;const value=element.dataset.value;element.parentElement.querySelectorAll('.rating-box').forEach(el=>el.classList.remove('selected'));element.classList.add('selected');saveAnswer(answerKey,value);scrollToNext(element.closest('.question'))}
        function handleCheckboxClick(checkbox){const group=checkbox.closest('.checkbox-group');const answerKey=group.dataset.key;const limit=parseInt(group.dataset.limit,10);if(limit===1){if(checkbox.checked){group.querySelectorAll('input[type="checkbox"]').forEach(cb=>{if(cb!==checkbox){cb.checked=false}})}}else if(limit>1){const checkedInputs=group.querySelectorAll('input[type="checkbox"]:checked');if(checkedInputs.length>limit){checkbox.checked=false;const questionDiv=checkbox.closest('.question');questionDiv.style.backgroundColor='#fff0f0';setTimeout(()=>{questionDiv.style.backgroundColor=''},1000);const errorEl=questionDiv.querySelector('.error-message-inline');if(errorEl){errorEl.textContent=`转 专 注 ${limit} 驻砖专转 .`;setTimeout(()=>{if(errorEl.textContent.includes('驻砖专转 '))errorEl.textContent=''},3000)}
        return}}
        const finalValues=Array.from(group.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);saveAnswer(answerKey,finalValues);scrollToNext(checkbox.closest('.question'))}
        function handleSelectChange(optionElement,selectWrapper,safeId){const value=optionElement.dataset.value;const otherInput=document.getElementById(`other_${safeId}`);const answerKey=selectWrapper.dataset.answerKey;if(otherInput){otherInput.style.display=(value==='专')?'block':'none';if(value!=='专')otherInput.value=''}
        const finalValue=(value==='专'&&otherInput)?`专: ${otherInput.value}`:value;saveAnswer(answerKey,finalValue);if(value!=='专'){scrollToNext(selectWrapper.closest('.question'))}}
        function handleTyping(inputElement){const key=inputElement.closest('.question')?.dataset.key;if(key){answers[key]=inputElement.value}}
        function handleTextBlur(inputElement){const parentQuestion=inputElement.closest('.question');if(!parentQuestion)return;const key=parentQuestion.dataset.key;saveAnswer(key,inputElement.value);scrollToNext(parentQuestion)}
        function handleFileSelect(fileInput,answerKey,safeId){const file=fileInput.files[0];const fileNameEl=document.getElementById(`file-name-${safeId}`);if(!file)return;if(!answerKey){fileNameEl.textContent="砖:  转 砖.";fileNameEl.classList.add('error');console.error("File upload failed: answerKey parameter was not received.");return}
        fileNameEl.textContent='';fileNameEl.className='file-name-display';const loadingSpan=document.createElement('span');loadingSpan.textContent='注 转 拽抓...';const spinner=document.createElement('div');spinner.className='spinner-inline';loadingSpan.appendChild(spinner);fileNameEl.appendChild(loadingSpan);const reader=new FileReader();reader.onload=e=>{const fileObject={filename:file.name,mimeType:file.type,base64:e.target.result.split(',')[1]};const requestBody={action:'uploadFile',payload:fileObject};fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify(requestBody),headers:{'Content-Type':'text/plain;charset=utf-8'}}).then(response=>response.json()).then(data=>onFileUploadComplete(data,answerKey,safeId)).catch(err=>onFileUploadComplete({success:false,error:err.message},answerKey,safeId))};reader.readAsDataURL(file)}
        function onFileUploadComplete(response,answerKey,safeId){const fileNameEl=document.getElementById(`file-name-${safeId}`);fileNameEl.innerHTML='';if(response.success){fileNameEl.textContent=response.filename;fileNameEl.classList.add('success');saveAnswer(answerKey,{url:response.url,filename:response.filename});scrollToNext(fileNameEl.closest('.file-upload-block, .question'))}else{fileNameEl.textContent=`砖: ${response.error}`;fileNameEl.classList.add('error');saveAnswer(answerKey,null)}}
        function saveAnswer(key,value){if(key===undefined||key===null){console.error("saveAnswer was called with an undefined/null key. Aborting save.",value);return}
        answers[key]=Array.isArray(value)?value.join(', '):value;const escapedKey=key.replace(/'/g,"\\'").replace(/"/g,'\\"');const element=document.querySelector(`[data-required="true"][data-key="${escapedKey}"]`);if(element){const answer=answers[key];const isEmpty=!answer||(typeof answer==='object'&&!answer.url)||(Array.isArray(answer)&&answer.length===0)||(typeof answer==='string'&&String(answer).trim()===''||answer===false);element.classList.toggle('invalid',isEmpty);const errorEl=element.querySelector('.error-message-inline');if(errorEl){errorEl.textContent=isEmpty?' 砖转 .':''}
        if(!isEmpty){element.classList.remove('invalid');const errorEl=element.querySelector('.error-message-inline');if(errorEl)errorEl.textContent=''}}}
        function validateRequiredQuestions(){let allValid=true;let firstInvalidElement=null;document.querySelectorAll('[data-required="true"]').forEach(element=>{const key=element.dataset.key;if(!key)return;const answer=answers[key];const isEmpty=!answer||(typeof answer==='object'&&!answer.url)||(Array.isArray(answer)&&answer.length===0)||(typeof answer==='string'&&String(answer).trim()===''||answer===false);element.classList.toggle('invalid',isEmpty);const errorEl=element.querySelector('.error-message-inline');if(errorEl){errorEl.textContent=isEmpty?' 砖转 .':''}
        if(isEmpty&&!firstInvalidElement){allValid=false;firstInvalidElement=element}});if(!allValid){firstInvalidElement.scrollIntoView({behavior:'smooth',block:'center'});ui.error.textContent='砖 砖 转  砖转  (住转 ).';ui.error.style.display='block';setTimeout(()=>{ui.error.style.display='none'},5000)}
        return allValid}
        function handleScroll(){if(stickyHeaderPoint&&window.scrollY>stickyHeaderPoint){ui.progressHeader.classList.add('progress-header-sticky')}else{ui.progressHeader.classList.remove('progress-header-sticky')}}
        function nextSection(){if(!validateRequiredQuestions())return;sectionHistory.push(currentSection);setNextJumpFromCurrentAnswers();let targetSection;if(nextSectionJump!==null){targetSection=nextSectionJump}else if(currentSection<sections.length-1){targetSection=currentSection+1}else{return}
        nextSectionJump=null;transitionToSection(targetSection)}
        function previousSection(){nextSectionJump=null;if(sectionHistory.length>0){const targetSection=sectionHistory.pop();transitionToSection(targetSection)}}
        function transitionToSection(targetIndex){const questionsEl=ui.questionsContainer;questionsEl.classList.add('fade-out');setTimeout(()=>{currentSection=targetIndex;displayCurrentSection();ui.container.scrollIntoView({behavior:'auto'});questionsEl.classList.remove('fade-out');questionsEl.classList.add('fade-in');setTimeout(()=>questionsEl.classList.remove('fade-in'),300)},250)}
        function setNextJumpFromCurrentAnswers(){const sectionName=sections[currentSection];const items=questionnaireData[sectionName].items||[];nextSectionJump=null;for(const item of items){if(item.type.toLowerCase().startsWith('专 转 专砖')&&item.section_jumps){const answerKey=`${sectionName}: ${sanitizeTextForKey(item.question)}`;const answer=answers[answerKey];const selectedValue=(answer||'').startsWith('专: ')?'专':answer;if(selectedValue){const jump=item.section_jumps.find(j=>j.value===selectedValue);if(jump&&jump.target_section){const targetIndex=sections.indexOf(jump.target_section);if(targetIndex>-1){nextSectionJump=targetIndex;return}}}}}}
        function updateProgressBars(){const sectionsProgress=sections.length>0?((sectionHistory.length+1)/sections.length)*100:0;ui.progressBar.style.width=`${sectionsProgress}%`;ui.sectionInfo.textContent=`拽注 ${currentSection+1} 转 ${sections.length}`;const sectionName=sections[currentSection];const questionItems=(questionnaireData[sectionName]?.items||[]).filter(item=>item.type.toLowerCase()!=='专转');if(questionItems.length===0){ui.sectionProgressWrapper.innerHTML='';return}
        let answeredCount=0;questionItems.forEach(item=>{const answerKey=`${sectionName}: ${sanitizeTextForKey(item.question)}`;const answer=answers[answerKey];if(answer!==undefined&&answer!==null&&String(answer).trim()!==""&&(typeof answer!=='object'||answer.url)){answeredCount++}});const sectionProgress=questionItems.length>0?(answeredCount/questionItems.length)*100:0;ui.sectionProgressWrapper.innerHTML=`<div class="section-progress-container"><div class="section-progress-bar" style="width: ${sectionProgress}%;"></div></div><div class="section-progress-info">砖转 砖注: ${answeredCount} 转 ${questionItems.length}</div>`}
        function checkForDraft(){const draftData=loadLocalDraft();if(draftData&&Object.keys(draftData.answers).length>0){const savedDate=new Date(draftData.timestamp);const dialog=document.createElement('div');dialog.className='draft-dialog';dialog.innerHTML=`<div class="draft-dialog-content"><h3>爪  砖专</h3><p>爪 转拽转 - ${savedDate.toLocaleDateString('he-IL')} 砖注 ${savedDate.toLocaleTimeString('he-IL')}.</p><p style="margin-top: 10px;"> 专爪 砖 拽  驻住拽转?</p><div class="draft-dialog-buttons"><button id="load-draft-btn" class="btn">, 注 </button><button id="discard-draft-btn" class="btn" style="background: #ccc; color: #333;">, 转 砖</button></div></div>`;document.body.appendChild(dialog);document.getElementById('load-draft-btn').addEventListener('click',()=>{answers=draftData.answers;sectionHistory=draftData.sectionHistory||[];dialog.remove();transitionToSection(draftData.currentSection);startAutosave()});document.getElementById('discard-draft-btn').addEventListener('click',()=>{localStorage.removeItem('questionnaireAutoSave_'+sessionToken);dialog.remove();displayCurrentSection();startAutosave()});return true}
        return false}
        function startAutosave(){if(autosaveInterval)clearInterval(autosaveInterval);saveLocalDraft();autosaveInterval=setInterval(saveLocalDraft,30000)}
        function onSubmitError(error){showView(ui.questionnaire);ui.error.style.display='block';ui.error.textContent=`砖 砖转 转砖转: ${error.toString()}`;ui.submitBtn.disabled=false}
        function updateNavigation(){ui.prevBtn.style.visibility=(sectionHistory.length===0)?'hidden':'visible';const isLastSection=currentSection>=sections.length-1&&nextSectionJump===null;ui.nextBtn.style.display=isLastSection?'none':'inline-block';ui.submitBtn.style.display=isLastSection?'inline-block':'none'}
        function showView(view){[ui.intro,ui.loading,ui.questionnaire,ui.success,ui.error].forEach(v=>v.style.display='none');view.style.display='block'}
        function onLoadError(error){showView(ui.error);ui.error.textContent=`砖 注转 砖: ${error.message}.  砖拽 砖 (拽) 转拽  爪 注专.`;ui.headerTitle.textContent='砖转 砖'}
        function shuffleArray(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}return array}

        ui.startBtn.addEventListener('click',startQuestionnaire);
        ui.nextBtn.addEventListener('click',nextSection);
        ui.prevBtn.addEventListener('click',previousSection);
        ui.submitBtn.addEventListener('click',submitQuestionnaire);
        window.addEventListener('scroll',handleScroll);
        
        init();
    </script>
</body>
</html>
